const spreadsheetId = '1DPxfNEfgupBq2ZF7s1pXgvVkKQXBJE-Jn1FlIlwhDbE';
const sheetName = 'test (Responses)';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const name = data.name;
    const number = parseInt(data.number);

    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getSheetByName(sheetName);

    const nameColumn = sheet.getRange("A:A").getValues().flat();
    let rowIndex = nameColumn.indexOf(name);

    if (rowIndex === -1) {
      rowIndex = nameColumn.filter(v => v !== "").length;
      sheet.getRange(rowIndex + 1, 1).setValue(name);
    }

    const row = sheet.getRange(rowIndex + 1, 2, 1, 12).getValues()[0];
    let lastFilledIndex = row.lastIndexOf(row.find(cell => cell === "") || "") - 1;

    if (lastFilledIndex < 0) {
      lastFilledIndex = row.filter(cell => cell !== "").length - 1;
    }

    const nextColumn = lastFilledIndex + 2;
    sheet.getRange(rowIndex + 1, nextColumn).setValue(number);

    return ContentService.createTextOutput(JSON.stringify({ success: true }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getAllNames() {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getSheetByName(sheetName);
    const nameColumn = sheet.getRange("A:A").getValues();
    const uniqueNames = [...new Set(nameColumn.flat().filter(String))]; // Get unique names and remove empty strings
    Logger.log('Unique Names: ' + uniqueNames);
    return uniqueNames;
  } catch (error) {
    Logger.log(`Error in getAllNames: ${error.message}`);
    return [];
  }
}

function processFormData(spreadsheetId, sheetName, identifier, number) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getSheetByName(sheetName);

    let range = sheet.getRange("A:A").getValues();
    let found = false;
    let rowIndex = -1;

    // Check if the identifier (name) exists in the specified column
    for (let i = 0; i < range.length; i++) {
      if (range[i][0] === identifier) {
        rowIndex = i + 1;
        found = true;
        Logger.log(`Identifier ${identifier} found at row ${rowIndex}`);
        break;
      }
    }

    // If the identifier is found, add the number in the first empty column
    if (found) {
      const rowValues = sheet.getRange(rowIndex, 2, 1, 12).getValues()[0];
      let lastFilledIndex = -1;
      for (let i = 0; i < rowValues.length; i++) {
        if (rowValues[i] !== '') {
          lastFilledIndex = i;
        }
      }

      if (lastFilledIndex + 1 < rowValues.length) {
        sheet.getRange(rowIndex, lastFilledIndex + 3).setValue(number); // Add number to the next empty cell
      } else {
        Logger.log("No more columns available to add the number.");
      }
    } else {
      // If the identifier is not found, add a new row with the identifier and number
      const lastRowWithName = sheet.getRange("A:A").getValues().filter(row => row[0] !== "").length;
      sheet.getRange(lastRowWithName + 1, 1).setValue(identifier); // Add name in the first column
      sheet.getRange(lastRowWithName + 1, 2).setValue(number); // Add number in the second column
    }

    // Perform zero-filling for all rows based on the largest column filled
    zeroFillAllRows(sheet);

    return { success: true };
  } catch (error) {
    Logger.log(`Error: ${error.message}`);
    return { success: false, message: error.message };
  }
}

function zeroFillAllRows(sheet) {
  const allRows = sheet.getRange(2, 2, sheet.getLastRow() - 1, 12).getValues(); // Columns from 2 to 13
  let maxColumnIndex = -1;

  // Find the largest filled column
  for (let i = 0; i < allRows.length; i++) {
    const currentRow = allRows[i];
    for (let j = 0; j < currentRow.length; j++) {
      if (currentRow[j] !== '') {
        maxColumnIndex = Math.max(maxColumnIndex, j);
      }
    }
  }

  // Zero-fill all rows up to the largest filled column
  const lastFilledColumn = maxColumnIndex + 2;
  for (let i = 0; i < allRows.length; i++) {
    for (let j = 0; j < lastFilledColumn; j++) {
      if (allRows[i][j] === '') {
        allRows[i][j] = 0;
      }
    }
    sheet.getRange(i + 2, 2, 1, lastFilledColumn).setValues([allRows[i]]);
  }
}
